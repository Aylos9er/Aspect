############################################################
# Makefile for building documentation
############################################################

aspect-files      = $(shell echo ../include/aspect/*.h \
                            ../include/aspect/*/*.h     \
                            ../include/aspect/*/*/*.h   \
                            modules/*.h)

# List all changelog files including the relative path and make sure to ignore
# the .gitkeep file. Use find instead of ls because the directory might have
# no changes in it:
change-files = $(shell find modules/changes/ -type f -not -name '.*')

default:
	@echo "make targets:"
	@echo "  aspect.tag  - generates doxygen documentation into doxygen/"
	@echo "  all         - same as above"

all: aspect.tag


# Generate changes.h from the bits in modules/changes/
modules/changes.h: $(change-files) modules/create_changes.sh modules/current_changes_*
	@cd modules && bash create_changes.sh

# build the documentation. see if we can download the latest
# deal.II deal.tag file generated by doxygen and if so
# use it to cross-reference the deal.II documentation from the
# aspect documentation
aspect.tag: $(aspect-files) $(change-files) modules/changes.h options.dox Makefile
	@if test ! -x "`which doxygen`" ; then \
	  echo "-----------------------------------------" ; \
	  echo "Can't find 'doxygen'." ; \
	  echo "-----------------------------------------" ; \
	  false ; \
	 fi
	@echo "=====aspect=================== Generating documentation"
	@echo '@INCLUDE = options.dox'                                > aspect.dox
	@echo 'DOT_IMAGE_FORMAT = png'                               >> aspect.dox
	@if wget -N https://www.dealii.org/developer/doxygen/deal.tag ; then \
	  echo 'Cross-linking deal.II documentation from the ASPECT documentation' ; \
	  echo 'TAGFILES = deal.tag=https://www.dealii.org/developer/doxygen/deal.II'          >> aspect.dox ; \
	 fi
	@echo 'IMAGE_PATH = logo manual'                             >> aspect.dox
	@echo 'PROJECT_NAME = "ASPECT"'                              >> aspect.dox
	@echo 'INPUT = $(aspect-files)'                              >> aspect.dox
	@echo 'HTML_OUTPUT      = doxygen'                           >> aspect.dox
	@echo 'GENERATE_TAGFILE = $@'                                >> aspect.dox
	@doxygen aspect.dox || echo "Running doxygen to generate documentation failed."

clean:
	-rm -f aspect.dox aspect.tag
	-rm -rf doxygen
