# Test the adjoint equations using a spherical perturbation in a
# 2D spherical shell

set Dimension                              = 2
set Use years in output instead of seconds = true
set End time                               = 0
set Pressure normalization                 = surface
set Surface pressure                       = 0

# Choose the adjoint solver scheme and set the number of iterations to 1
# (i.e. don't iterate over the parameters)
set Nonlinear solver scheme                = no Advection, adjoint Stokes
set Max nonlinear iterations               = 1


subsection Material model
  # additive means after each iteration we add the value stored in the
  # composition field to the existing density / multiply the viscosity
  # with the new composition field
  set Model name = additive

  subsection Additive model
     set Base model = simple
  end

  subsection Simple model
    set Thermal expansion coefficient = 4e-5
    set Viscosity                     = 1e21
    set Thermal viscosity exponent    = 3
    set Reference temperature         = 1600
  end
end

# to run sensibly with no Advection, adjoint stokes we require the following parameters:
# Composition polynomial degree of 0
# Additive material model
# At least 2 compositional fields with exactly those names
subsection Discretization
  set Composition polynomial degree        = 0
  set Use discontinuous composition discretization = true
end

subsection Compositional fields
  set Number of fields = 2
  set Names of fields = density_increment, viscosity_factor
end

subsection Initial composition model
  set Model name = function

  subsection Function
    # before the iteration the density term should be 0 and the
    # viscosity prefactor should be 1
    # this means the addition to density at the first iteration is 0
    # while the multiplication to viscosity is 1
    # these scalar values are prescribed everywhere in 3D field
    # during iteration the composition value will reflect the incremental addition
    # multiplication
    set Function expression = 0 ; 1
  end
end


subsection Geometry model
  set Model name = spherical shell

  subsection Spherical shell
    set Inner radius  = 3481000
    set Outer radius  = 6336000
  end
end


subsection Boundary velocity model
  set Zero velocity boundary indicators       =
  set Tangential velocity boundary indicators = inner, outer
  set Prescribed velocity boundary indicators =
end

subsection Boundary temperature model
  set Fixed temperature boundary indicators   = inner, outer
end


subsection Nullspace removal
  set Remove nullspace = net rotation
end

subsection Boundary temperature model
  set Model name = spherical constant
  subsection Spherical constant
    set Inner temperature = 4273
    set Outer temperature = 973
  end
end


subsection Initial temperature model
  set Model name = spherical hexagonal perturbation

  subsection Spherical hexagonal perturbation
    set Angular mode = 4
  end
end


subsection Gravity model
  set Model name = radial constant

  subsection Radial constant
    set Magnitude = 10
  end

end


subsection Mesh refinement
  set Initial global refinement          = 2
  set Initial adaptive refinement        = 0
end


subsection Postprocess
  set List of postprocessors = adjoint kernels, dynamic topography, visualization

  set Run postprocessors on nonlinear iterations = true

  subsection Visualization
    set List of output variables      = viscosity, density
    set Output format                 = vtu
    set Time between graphical output = 0
  end
end
