# A test for controlling the viscosity and density of composition called spcrust 
# in the visco_plastic material model.
# This is useful for models in which the crustal layer subducts
# This test modifies the visco_plastic_diffusion_dislocation_composite test
# by adding a composition spcrust (vertical column at center)
# The density and viscosity change linearly from 25 to 75 km depth
# (P = 3e9 + 3300*10*y: 3.825e9 to 5.475e9 Pa)
# Reference density for spcrust changes from 3200 to 3400 (drho = 200 kg/m^3)
# But the actual density depends on the temperature and thermal expansivity (3240-3452)
# Viscosity changes from 1e20 to the flow-law value, which uses the same parameters as
# for the mantle. Mantle viscosity goes from 2.17e22 (top) to 4.46e22 (bottom) Pa s
# Note that the strain-rate is not uniform due to the imposed low viscosity region
 
# Global parameters
set Dimension                              = 2
set Start time                             = 0
set End time                               = 0
set Use years in output instead of seconds = true
set Nonlinear solver scheme                = single Advection, iterated Stokes
set Max nonlinear iterations               = 1
set Output directory                       = visco_plastic_spcrust
set Surface pressure                       = 3.e9

# Model geometry (100x100 km, 10 km spacing)
subsection Geometry model
  set Model name = box
  subsection Box
    set X repetitions = 10
    set Y repetitions = 10
    set X extent      = 100e3
    set Y extent      = 100e3
  end
end

subsection Mesh refinement
  set Initial adaptive refinement        = 0
  set Initial global refinement          = 0
  set Time steps between mesh refinement = 0
end

# Boundary classifications (fixed T boundaries, prescribed velocity) 
# The parameters below this comment were created by the update script
# as replacement for the old 'Model settings' subsection. They can be
# safely merged with any existing subsections with the same name.

subsection Boundary temperature model
  set Fixed temperature boundary indicators   = bottom, top, left, right
end

subsection Boundary velocity model
  set Prescribed velocity boundary indicators = bottom y: function, top y: function, left x: function, right x: function
end

# Velocity on boundaries characterized by functions
subsection Boundary velocity model
  subsection Function
    set Variable names      = x,y
    set Function constants  = mm=0.001, year=1
    set Function expression = if (x<50e3 , -0.5*mm/year, 0.5*mm/year); if (y<50e3 , 0.5*mm/year, -0.5*mm/year);
  end
end

# Temperature boundary and initial conditions
subsection Boundary temperature model
  set List of model names = box
  subsection Box
    set Bottom temperature = 1173
    set Left temperature   = 1173
    set Right temperature  = 1173
    set Top temperature    = 1173
  end
end

subsection Initial temperature model
  set Model name = function
  subsection Function
    set Function expression = 1173
  end
end

subsection Compositional fields
   set Number of fields = 1
   set Names of fields = spcrust
   set Compositional field methods = field
end

subsection Initial composition model
   set List of model names = function
   set List of model operators = add

   subsection Function
      set Coordinate system = cartesian
      set Variable names = x, y
      set Function constants = x1=30e3, x2=70e3
      set Function expression = ((x>=x1)&&(x<=x2)? 1.0: 0.0)
   end
end


# Material model (mantle & spcrust)
subsection Material model
  set Model name = visco plastic
  subsection Visco Plastic
    set Reference temperature = 1673
    set Reference strain rate = 1.e-16
    set Viscous flow law = composite
    set Grain size = 1.e-3
    set Grain size exponents for diffusion creep 	=       3.,       3.
    set Prefactors for diffusion creep 			= 2.37e-15, 2.37e-15
    set Activation energies for diffusion creep 	=   375.e3,   375.e3
    set Activation volumes for diffusion creep 		=   10.e-6,   10.e-6
    set Prefactors for dislocation creep 		= 6.52e-16, 6.52e-16
    set Stress exponents for dislocation creep 		=      3.5,      3.5
    set Activation energies for dislocation creep 	=   530.e3,   530.e3
    set Activation volumes for dislocation creep 	=   10.e-6,   10.e-6
    
    set Densities             				=     3300,     3200
    set Thermal expansivities 				=   3.1e-5,   3.1e-5
    set Use fixed spcrust viscosity = true
    set Maximum spcrust viscosity = 1e20
    set Minimum transition pressure spcrust viscosity = 3.825e9 # Pa, 25 km (+Psurf = 3e9)
    set Maximum transition pressure spcrust viscosity = 5.475e9 # Pa, 75 km (+Psurf = 3e9)

    set Use spcrust density change = true
    set Density change from spcrust = 200  # kg/m^3
    set Minimum transition pressure spcrust density = 3.825e9 # Pa, 25 km (+Psurf = 3e9)
    set Maximum transition pressure spcrust density = 5.475e9 # Pa, 75 km (+Psurf = 3e9)

  end
end

subsection Gravity model
  set Model name = vertical
  subsection Vertical
    set Magnitude = 10.0
  end
end

subsection Postprocess
  set List of postprocessors = velocity statistics, mass flux statistics, visualization
  subsection Visualization
    set List of output variables = viscosity, strain rate, density
    set Output format            = gnuplot
  end
end

subsection Solver parameters
  subsection Stokes solver parameters
    set Number of cheap Stokes solver steps = 0
  end
end

